<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>LAN WebRTC Chat</title>
<style>
body {
    margin: 0;
    font-family: "Segoe UI", sans-serif;
    background: #e9ecef;
    color: #333;
    height: 100vh;
    display: flex;
}

body.dark {
    background: #1e1e1e;
    color: #ddd;
}

body.dark #sidebar {
    background: #2b2b2b;
    border-right: 1px solid #444;
}

body.dark #chatLog {
    background: #2b2b2b;
    border-color: #444;
}

body.dark input,
body.dark textarea {
    background: #333;
    color: #eee;
    border: 1px solid #555;
}

body.dark button {
    background: #444;
    color: #eee;
    border: 1px solid #666;
}

body.dark button:hover {
    background: #555;
}

#sidebar {
    width: 250px;
    background: #f8f9fa;
    border-right: 1px solid #ccc;
    padding: 1em;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    gap: 0.6em;
    position: relative;
}

#sidebar h2 {
    font-size: 1.1em;
    margin: 0.3em 0;
    color: inherit;
}

input[type=text],
textarea {
    width: 100%;
    padding: 0.4em;
    border: 1px solid #aaa;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
}

textarea {
    height: 100px;
    resize: none;
}

button {
    padding: 0.4em 0.8em;
    border: 1px solid #666;
    border-radius: 4px;
    background: #f1f1f1;
    cursor: pointer;
    font-size: 14px;
}

button:hover {
    background: #e2e2e2;
}

#status {
    font-size: 0.9em;
    font-weight: bold;
    margin-top: 0.5em;
    color: green;
}

#darkToggle {
    position: absolute;
    bottom: 10px;
    left: 10px;
    font-size: 12px;
    padding: 0.3em 0.6em;
}

#chatContainer {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 1em;
    box-sizing: border-box;
}

#chatLog {
    flex: 1;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 0.6em;
    overflow-y: auto;
    margin-bottom: 0.5em;
    display: flex;
    flex-direction: column;
}

.msg {
    margin: 0.3em 0;
    word-wrap: break-word;
}

.msg b {
    margin-right: 0.4em;
}

#chatInputArea {
    display: flex;
    gap: 0.5em;
}

#chatInput {
    flex: 1;
    padding: 0.5em;
    border: 1px solid #aaa;
    border-radius: 4px;
    font-size: 14px;
}

#sendBtn {
    background: #007bff;
    color: white;
    border: none;
}

#sendBtn:hover {
    background: #0069d9;
}
</style>
</head>
<body>
<div id="sidebar">
    <h2>Connection</h2>
    <input type="text" id="nickname" placeholder="Your nickname">
    <button id="hostBtn">Host LAN</button>
    <button id="joinBtn">Join LAN</button>
    <h2>Offer / Answer</h2>
    <textarea id="signalBox" placeholder="Paste offer/answer here"></textarea>
    <label><input type="checkbox" id="quickConnect">this does nothing</label>
    <button id="pasteBtn">Paste Remote</button>
    <div id="status">Not connected</div>
    <button id="darkToggle">ðŸŒ™ Dark Mode</button>
</div>

<div id="chatContainer">
    <h2>LAN Chat</h2>
    <div id="chatLog"></div>
    <div id="chatInputArea">
        <input id="chatInput" type="text" placeholder="Type message...">
        <button id="sendBtn">Send</button>
    </div>
</div>

<script>
let peers = {}, channels = [], nickname = "";
const hostBtn = document.getElementById("hostBtn"),
      joinBtn = document.getElementById("joinBtn"),
      pasteBtn = document.getElementById("pasteBtn"),
      signalBox = document.getElementById("signalBox"),
      status = document.getElementById("status"),
      chatLog = document.getElementById("chatLog"),
      chatInput = document.getElementById("chatInput"),
      sendBtn = document.getElementById("sendBtn"),
      darkToggle = document.getElementById("darkToggle"),
      nickInput = document.getElementById("nickname");

// --- UI helpers ---
function logStatus(msg,g=true) {
    status.textContent = msg;
    status.style.color = g ? "green" : "red";
}

function logChat(msg,who) {
    const p = document.createElement("div");
    p.className = "msg";
    p.innerHTML = `<b>${who}:</b> ${msg}`;
    chatLog.appendChild(p);
    chatLog.scrollTop = chatLog.scrollHeight;
}

function setupChannel(c,label) {
    c.onopen = () => logStatus("Connected to " + label);
    c.onmessage = e => {
        let d = JSON.parse(e.data);
        if(d.nick) logChat(d.msg,d.nick);
    };
    channels.push(c);
}

// --- Broadcast ---
function broadcast(msg,extra={}) {
    const d = JSON.stringify({nick:nickname,msg,...extra});
    channels.forEach(c=>{if(c.readyState==="open") c.send(d);});
}

// --- Send message ---
function sendMessage() {
    const m = chatInput.value.trim();
    if(!m) return;
    logChat(m,nickname);
    broadcast(m);
    chatInput.value = "";
}

sendBtn.onclick = sendMessage;
chatInput.addEventListener("keydown",e => {if(e.key==="Enter") sendMessage();});

// --- ICE helper ---
async function waitForIce(pc) {
    if(pc.iceGatheringState==="complete") return;
    return new Promise(r=>{
        pc.addEventListener("icegatheringstatechange", function c(){
            if(pc.iceGatheringState==="complete") {
                pc.removeEventListener("icegatheringstatechange",c);
                r();
            }
        });
    });
}

// --- Host ---
hostBtn.onclick = async () => {
    nickname = nickInput.value || "Host";
    let pc = new RTCPeerConnection();
    let channel = pc.createDataChannel("chat");
    setupChannel(channel,"Joiner");
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await waitForIce(pc);
    signalBox.value = JSON.stringify(pc.localDescription);
    logStatus("Offer ready. Copy this to Joiner.");
    peers["joiner"] = pc;
};

// --- Join ---
joinBtn.onclick = () => {
    nickname = nickInput.value || "Guest";
    logStatus("Paste host offer into the box and click Paste Remote");
};

// --- Paste remote ---
pasteBtn.onclick = async () => {
    if(!signalBox.value.trim()){alert("Paste a valid host offer first!"); return;}
    let desc = JSON.parse(signalBox.value);
    if(desc.type==="offer"){
        let pc = new RTCPeerConnection();
        pc.ondatachannel = e => setupChannel(e.channel,"Host");
        await pc.setRemoteDescription(desc);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await waitForIce(pc);
        signalBox.value = JSON.stringify(pc.localDescription);
        logStatus("Answer ready. Copy back to Host.");
        peers["host"] = pc;
    } else if(desc.type==="answer"){
        let pc = Object.values(peers)[0];
        await pc.setRemoteDescription(desc);
        logStatus("Remote answer set. Waiting for connection...");
    }
};

// --- Dark mode ---
if(localStorage.getItem("darkMode")==="true") document.body.classList.add("dark");
darkToggle.onclick = () => {
    document.body.classList.toggle("dark");
    localStorage.setItem("darkMode", document.body.classList.contains("dark"));
};
</script>
</body>
</html>
